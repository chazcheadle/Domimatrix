tinymce.PluginManager.add('domimatrix', function(editor, url) {

    // On blur, trigger recalculation of content.
    editor.on('blur', function (event) {
        processContent();
    }),
    // Prevent blank paragraphs from being created.
    editor.on('keyup', function (event) {
        if (event.keyCode == 13) {
            if ($(tinymce.activeEditor.selection.getNode()).prev().text() == ''
                && !$(tinymce.activeEditor.selection.getNode()).prev().hasClass('adp')) {
                $(tinymce.activeEditor.selection.getNode()).remove();
            }
            processContent();
        }
    })
});

// Calculate placement of ads and related content.
function processContent() {
    $content = tinymce.activeEditor.dom.select('p');
    console.log('length: ' + $content.length);
    content = tinymce.activeEditor.dom.select('p');
    $(content).find('img.insert').parent().remove();
    $content = tinymce.activeEditor.dom.select('p');
    numParas = $content.length;
    console.log('(' + numParas + ' - ' + relatedPos + ') * ' + recommendedPos + ' / 100');
    recPos = Math.floor((numParas - relatedPos) * recommendedPos / 100);
    $content.forEach(function(text, index) {
        if (index == relatedPos) {
            $(text).before($("<p class='adp'><img class='insert' src='./related.png' height='100px'></p>"));
        }
        if (index >= recommendedMin && index == recPos + relatedPos) {
            $(text).before($("<p class='adp'><img class='insert' src='./recommended.png' height='100px'></p>"));
        }
    });
}